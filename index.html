<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script
			type="text/javascript"
			src="https://unpkg.com/bsv@1.5.0/bsv.min.js"
		></script>

		<!-- <script src="./node_modules/uuidjs/dist/uuid.core.js"></script> -->
		<script>
			// let uuid = crypto.randomUUID();
		</script>
		<link rel="stylesheet" href="./style.css" />

		<title>ChainWriter</title>
	</head>
	<body>
		<div id="header"><h1>ChainWriter - MetaStreme Tool</h1></div>
		<div id="main">
			<input id="message" placeholder="your message" type="text" />

			<button onclick="makePost()">Click Test</button>

			<br />
			<h2 id="success"></h2>
			<div id="myTransactions">
				<ul id="transactionList"></ul>
			</div>
			<div id="getPost"></div>
			<h3 style="word-wrap: break-word" id="getTx"></h3>
		</div>
		<div id="footer">
			<button onclick="logout()" id="logout">Logout</button>
		</div>
		<script>
			const getApi = () => {
				let api = prompt("Enter Your MetaStreme API Key");
				if (api === null) {
					getApi();
				} else localStorage.setItem("apiKey", api);
				return api;
			};
			let apiKey =
				localStorage.apiKey && localStorage.apiKey != null
					? localStorage.apiKey
					: getApi();

			const logout = () => {
				localStorage.clear();
				location.reload();
			};

			const myPostData = () => {
				let myData = document.getElementById("message").value;
				let script = bsv.Script.buildSafeDataOut([myData]).toHex();
				let uuid = crypto.randomUUID();
				myPost = {
					v: "1",
					id: uuid,
					script,
				};
				return myPost;
			};

			const baseUrl = "https://portal.metastreme.com/api";
			const makePost = async () => {
				let myList = document.getElementById("transactionList");

				document.getElementById("transactionList").innerHTML = "";
				document.getElementById("success").innerHTML = "";
				document.getElementById("getPost").innerHTML = "";
				document.getElementById("getTx").innerHTML = "";
				var child = myList.lastElementChild;
				while (child) {
					myList.removeChild(child);
				}
				let response = fetch(`${baseUrl}/request`, {
					method: "POST",
					headers: {
						Authorization: apiKey,
						"Content-Type": "application/json",
					},
					body: await JSON.stringify(myPostData()),
				});
				console.log(response);
				if ((response.status = 200)) {
					let r = await Object.values(response);
					r.forEach(function (item) {
						let li = document.createElement("li");
						myList.appendChild(li);
						li.style.fontSize = "2rem";
						li.style.listStyle = "none";
						li.style.wordWrap = "break-word";
						li.innerHTML += `Code: ${item}`;
					});
					console.log(r);
					document.getElementById(
						"success"
					).innerHTML = `Sucesss UUID ${myPost.id}`;
					document.getElementById("message").value = "";
					setTimeout(() => {
						getPost(myPost.id);
					}, 5000);
				} else {
					alert("error, try again");
				}
			};
			const getPost = async (uuid) => {
				let txidRes = fetch(`${baseUrl}/request/${uuid}/status`, {
					method: "GET",
					headers: {
						Authorization: apiKey,
						"Content-Type": "application/json",
					},
				});
				const txid = await txidRes;
				const myTxid = await txid.json();

				console.log(myTxid);
				document.getElementById("getPost").innerHTML = `TXID: ${myTxid.txid}`;
				setTimeout(() => {
					getTx(myTxid.txid);
				}, 5000);
			};

			const getTx = async (myTxid) => {
				let txResponse = await fetch(`${baseUrl}/transaction/${myTxid}/`, {
					method: "GET",
					headers: {
						Authorization: apiKey,
						"Content-Type": "application/json",
						// Accept: "application/octet-stream",
					},
				});
				if ((txResponse.status = 200)) {
					console.log(txResponse.status);
					const t = await txResponse.blob();
					console.log(t);

					const u = await t.text();
					document.getElementById("getTx").innerHTML = `TXID Data: ${u}`;
				}
			};
		</script>
	</body>
</html>
