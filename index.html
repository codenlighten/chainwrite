<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script
			type="text/javascript"
			src="https://unpkg.com/bsv@1.5.0/bsv.min.js"
		></script>

		<!-- <script src="./node_modules/uuidjs/dist/uuid.core.js"></script> -->
		<script>
			var uuid = crypto.randomUUID();
			console.log(uuid);
		</script>
		<link rel="stylesheet" href="./style.css" />

		<title>ChainWriter</title>
	</head>
	<body>
		<h1>ChainWriter</h1>
		<input id="message" placeholder="your message" type="text" />

		<button onclick="makePost()">Click Test</button>
		<br />
		<input
			id="uuid"
			placeholder="check uuid status"
			type="text"
			onkeyup="getPost()"
		/>
		<br />
		<h2 id="success"></h2>
		<div id="myTransactions">
			<ul id="transactionList"></ul>
		</div>
		<div id="getPost"></div>
		<script>
			const getApi = () => {
				let api = prompt("Enter Your MetaStreme API Key");
				if (api === null) {
					getApi();
				} else localStorage.setItem("apiKey", api);
				return api;
			};
			let apiKey =
				localStorage.apiKey && localStorage.apiKey != null
					? localStorage.apiKey
					: getApi();

			let myData = document.getElementById("message").value || "Hello World";
			let script = bsv.Script.buildSafeDataOut([myData]).toHex();
			console.log(script);
			const myPost = {
				v: "1",
				id: uuid,
				script,
			};

			console.log(JSON.stringify(myPost));
			const baseUrl = "https://portal.metastreme.com/api";
			const makePost = async () => {
				let response = fetch(`${baseUrl}/request`, {
					method: "POST",
					headers: {
						Authorization: apiKey,
						"Content-Type": "application/json",
					},
					body: JSON.stringify(myPost),
				});
				console.log(response);
				if ((response.status = 200)) {
					let myList = document.getElementById("transactionList");
					let r = await Object.values(response);
					r.forEach(function (item) {
						let li = document.createElement("li");
						myList.appendChild(li);
						li.style.fontSize = "2rem";
						li.style.listStyle = "none";
						li.innerHTML += `Code: ${item}`;
					});
					console.log(r);
					document.getElementById("success").innerHTML = `Sucesss UUID ${uuid}`;
					document.getElementById("message").value = "";
					setTimeout(() => {
						getPost(uuid);
					}, 5000);
				} else {
					alert("error, try again");
				}
			};
			const getPost = async () => {
				let txidRes = fetch(`${baseUrl}/request/${uuid}/status`, {
					method: "GET",
					headers: {
						Authorization: apiKey,
						"Content-Type": "application/json",
					},
				});
				const txid = await txidRes;
				const b = await txid.json();
				console.log(b);
				document.getElementById("getPost").innerHTML = `TXID: ${b.txid}`;
			};
		</script>
	</body>
</html>
